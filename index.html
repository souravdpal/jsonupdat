<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product JSON Manager</title>
    <link rel="icon" href="data:,">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
        input, select, button { width: 90%; max-width: 400px; margin-bottom: 10px; padding: 10px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; text-align: left; max-width: 400px; margin: 10px auto; }
        .error { color: red; font-size: 14px; }
        @media (max-width: 500px) { input, select, button { width: 100%; } }
    </style>
</head>
<body>
    <h2>Enter Product Details</h2>
    
    <select id="fileChoice" onchange="fetchExistingJSON()">
        <option value="data.json">Update Data JSON</option>
        <option value="announcements.json">Update Announcements JSON</option>
    </select>

    <input type="text" id="name" placeholder="Product Name" required>
    <input type="text" id="category" placeholder="Category" required>
    <input type="text" id="subcategory" placeholder="Subcategory">
    <input type="url" id="img" placeholder="Image URL">
    <input type="url" id="link" placeholder="Product Link">
    <input type="number" id="price" placeholder="Price" min="0" step="0.01" required>
    <input type="number" id="rating" placeholder="Rating (1-5)" min="1" max="5" step="0.1">
    
    <button id="addBtn" onclick="addProduct()">Add Product</button>
    <h3>Current JSON Data</h3>
    <pre id="output">Loading...</pre>
    <div id="errorMsg" class="error"></div>
    
    <button id="updateBtn" onclick="updateGitHubJSON()" disabled>Update GitHub JSON</button>

    <script>
        const CONFIG = {
            username: "souryadypal",
            repo: "data_json",
            token: "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" // Replace with your new GitHub PAT
        };

        let products = [];
        const outputEl = document.getElementById('output');
        const errorEl = document.getElementById('errorMsg');
        const updateBtn = document.getElementById('updateBtn');

        async function fetchExistingJSON() {
            const selectedFile = document.getElementById('fileChoice').value;
            const url = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${selectedFile}`;

            try {
                outputEl.textContent = 'Loading...';
                errorEl.textContent = '';
                
                const response = await fetch(url, {
                    headers: { 
                        Authorization: `token ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Invalid GitHub token. Please check your token and ensure it has the correct permissions and repository access.');
                    } else if (response.status === 404) {
                        throw new Error('File not found in repository. Ensure the file exists.');
                    } else {
                        throw new Error(`GitHub API error: ${response.status} - ${response.statusText}`);
                    }
                }

                const fileData = await response.json();
                products = JSON.parse(atob(fileData.content));
                outputEl.textContent = JSON.stringify(products, null, 4);
                updateBtn.disabled = false;
            } catch (error) {
                products = [];
                outputEl.textContent = 'No data available';
                errorEl.textContent = `Error fetching JSON: ${error.message}`;
                updateBtn.disabled = true;
            }
        }

        function validateInputs() {
            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value.trim();
            const price = document.getElementById('price').value;

            if (!name || !category || !price) {
                errorEl.textContent = 'Name, Category, and Price are required';
                return false;
            }
            return true;
        }

        function addProduct() {
            if (!validateInputs()) return;

            const product = {
                id: Date.now(),
                name: document.getElementById('name').value.trim(),
                category: document.getElementById('category').value.trim(),
                subcategory: document.getElementById('subcategory').value.trim() || 'N/A',
                img: document.getElementById('img').value.trim() || '',
                link: document.getElementById('link').value.trim() || '',
                price: parseFloat(document.getElementById('price').value) || 0,
                rating: parseFloat(document.getElementById('rating').value) || 4.0
            };

            products.push(product);
            outputEl.textContent = JSON.stringify(products, null, 4);
            errorEl.textContent = '';
            
            document.querySelectorAll('input').forEach(input => input.value = '');
            updateBtn.disabled = false;
        }

        async function updateGitHubJSON() {
            const selectedFile = document.getElementById('fileChoice').value;
            const url = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${selectedFile}`;

            try {
                updateBtn.disabled = true;
                errorEl.textContent = 'Updating...';

                const fetchResponse = await fetch(url, {
                    headers: { 
                        Authorization: `token ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!fetchResponse.ok) {
                    if (fetchResponse.status === 401) {
                        throw new Error('Unauthorized: Invalid GitHub token. Please check your token and ensure it has the correct permissions and repository access.');
                    } else if (fetchResponse.status === 404) {
                        throw new Error('File not found in repository. Ensure the file exists.');
                    } else {
                        throw new Error(`Failed to fetch file: ${fetchResponse.status} - ${fetchResponse.statusText}`);
                    }
                }

                const fileData = await fetchResponse.json();
                const sha = fileData.sha;

                const updatedContent = btoa(JSON.stringify(products, null, 4));
                const commitMessage = `Updated ${selectedFile} - ${new Date().toISOString()}`;

                const updateResponse = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: updatedContent,
                        sha: sha
                    })
                });

                if (!updateResponse.ok) {
                    if (updateResponse.status === 401) {
                        throw new Error('Unauthorized: Invalid GitHub token. Please check your token and ensure it has the correct permissions and repository access.');
                    } else {
                        throw new Error(`Failed to update: ${updateResponse.status} - ${updateResponse.statusText}`);
                    }
                }

                errorEl.textContent = 'Successfully updated!';
                setTimeout(() => errorEl.textContent = '', 3000);
            } catch (error) {
                errorEl.textContent = `Error updating JSON: ${error.message}`;
                updateBtn.disabled = false;
            }
        }

        window.onload = fetchExistingJSON;
    </script>
</body>
</html>
